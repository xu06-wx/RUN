<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Web Reflex Ridge MVP – 骨架版</title>
<style>
  html,body{margin:0;overflow:hidden;background:#000;}
  #debugVideo{
    position:absolute;top:10px;right:10px;width:160px;height:120px;
    border:2px solid #00ffff;border-radius:8px;transform:scaleX(-1);z-index:5;
  }
  #hud{
    position:absolute;top:10px;left:10px;color:#fff;font-family:"Microsoft JhengHei";
    background:rgba(0,0,0,0.5);padding:6px 12px;border-radius:8px;z-index:3;
  }
  #hud span{display:block;margin:2px 0;}
  #popup{
    position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;
    align-items:center;justify-content:center;flex-direction:column;
    color:#fff;font-family:"Microsoft JhengHei";z-index:10;
  }
  #popup h2{margin-bottom:10px;}
  #popup button{
    margin-top:20px;padding:8px 16px;font-size:18px;
    border:none;border-radius:6px;background:#00bfff;color:#fff;cursor:pointer;
  }
</style>
</head>
<body>
  
<div id="hud">
  <span id="score">分數：0</span>
  <span id="timer">剩餘時間：60 秒</span>
  <span id="action">動作：--</span>
</div>
<div id="popup">
  <h2>遊戲結束！</h2>
  <p id="finalStats"></p>
  <button onclick="location.reload()">重新開始</button>
</div>
<video id="debugVideo" autoplay playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

<script>
// === THREE 基本設定 ===
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,2.5,8);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);
window.addEventListener("resize",()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});

scene.add(new THREE.AmbientLight(0xffffff,0.8));
const light=new THREE.DirectionalLight(0xffffff,0.8);
light.position.set(10,10,5);scene.add(light);

// === 地板 ===
const floor=new THREE.Mesh(new THREE.PlaneGeometry(20,200,10,50),new THREE.MeshPhongMaterial({color:0x222222,side:THREE.DoubleSide}));
floor.rotation.x=-Math.PI/2;
scene.add(floor);

// === 骨架人 ===
const skeletonGroup=new THREE.Group();
const mat=new THREE.MeshBasicMaterial({color:0x00ffff});
const bones=[];

function addBone(x,y,z){
  const geo=new THREE.SphereGeometry(0.1,8,8);
  const bone=new THREE.Mesh(geo,mat);
  bone.position.set(x,y,z);
  skeletonGroup.add(bone);
  bones.push(bone);
}
for(let i=0;i<33;i++)addBone(0,1.5,0);
scene.add(skeletonGroup);

// === 障礙物 ===
const obstacles=[];
function spawnObstacle(z){
  const geo=new THREE.BoxGeometry(1.5,1.5,1.5);
  const mat=new THREE.MeshPhongMaterial({color:0xff4444});
  const obs=new THREE.Mesh(geo,mat);
  obs.position.set((Math.random()-0.5)*6,0.75,z);
  scene.add(obs);
  obstacles.push(obs);
}
for(let i=0;i<10;i++)spawnObstacle(-i*20-10);

// === UI ===
const scoreEl=document.getElementById("score");
const timerEl=document.getElementById("timer");
const actionEl=document.getElementById("action");
const popup=document.getElementById("popup");
const finalStats=document.getElementById("finalStats");
const video=document.getElementById("debugVideo");

// === 遊戲變數 ===
let score=0;
let timeLeft=60;
let gameOver=false;
let currentAction="--";

// === Mediapipe Pose ===
const pose=new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({modelComplexity:0,smoothLandmarks:true,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
pose.onResults(onPose);

async function startCam(){
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;await video.play();
  const cam=new Camera(video,{onFrame:async()=>{await pose.send({image:video});},width:320,height:180});
  cam.start();
}
startCam();

// === 動作分析 ===
function onPose(res){
  if(!res.poseLandmarks)return;
  const lm=res.poseLandmarks;
  // 更新骨架點
  lm.forEach((p,i)=>{
    if(bones[i]){
      bones[i].position.set((p.x-0.5)*6,2.5-p.y*5,-0.2);
    }
  });

  const LHip=lm[23], RHip=lm[24];
  const LKnee=lm[25], RKnee=lm[26];
  const LShoulder=lm[11], RShoulder=lm[12];
  const Nose=lm[0];
  const centerX=(LShoulder.x+RShoulder.x)/2;
  const centerY=(LHip.y+RHip.y)/2;

  let action="--";
  if((LKnee.y+RKnee.y)/2 < (LHip.y+RHip.y)/2 - 0.15) action="Jump";
  else if((LShoulder.y+RShoulder.y)/2 > (LHip.y+RHip.y)/2 - 0.05) action="Crouch";
  else if(centerX < 0.4) action="Left";
  else if(centerX > 0.6) action="Right";

  if(action!==currentAction && action!=="--"){
    score+=1;
    scoreEl.textContent="分數："+score;
    currentAction=action;
  }
  actionEl.textContent="動作："+action;
}

// === 遊戲邏輯 ===
function updateObstacles(){
  obstacles.forEach(o=>{
    o.position.z+=0.1;
    if(o.position.z>5){
      o.position.z=-200;
      o.position.x=(Math.random()-0.5)*6;
    }
    // 判定撞擊
    const px=skeletonGroup.position.x;
    const py=skeletonGroup.position.y;
    const pz=0;
    if(Math.abs(o.position.z-pz)<1 && Math.abs(o.position.x-px)<1 && py<1.5){
      score=Math.max(0,score-2);
      scoreEl.textContent="分數："+score;
      o.position.z=-200;
    }
  });
}

// === 倒數 ===
const timer=setInterval(()=>{
  timeLeft--;
  timerEl.textContent=`剩餘時間：${timeLeft} 秒`;
  if(timeLeft<=0){
    clearInterval(timer);
    gameOver=true;
    popup.style.display="flex";
    finalStats.innerHTML=`最終分數：${score}`;
  }
},1000);

// === 動畫迴圈 ===
function animate(){
  requestAnimationFrame(animate);
  if(!gameOver){
    updateObstacles();
    renderer.render(scene,camera);
  }
}
animate();
</script>
</body>
</html>
