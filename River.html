<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Web River Rush 3D – 時速與倒數版</title>
<style>
  html,body{margin:0;overflow:hidden;background:#000;}
  #debugVideo{
    position:absolute;top:10px;right:10px;width:160px;height:120px;
    border:2px solid #00ffff;border-radius:8px;transform:scaleX(-1);z-index:5;
  }
  #hud{
    position:absolute;top:10px;left:10px;color:#fff;font-family:"Microsoft JhengHei";
    background:rgba(0,0,0,0.5);padding:6px 12px;border-radius:8px;z-index:3;
  }
  #hud span{display:block;margin:2px 0;}
  #popup{
    position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;
    align-items:center;justify-content:center;flex-direction:column;
    color:#fff;font-family:"Microsoft JhengHei";z-index:10;
  }
  #popup h2{margin-bottom:10px;}
  #popup button{
    margin-top:20px;padding:8px 16px;font-size:18px;
    border:none;border-radius:6px;background:#00bfff;color:#fff;cursor:pointer;
  }
</style>
</head>
<body>
  
<div id="hud">
  <span id="score">分數：0</span>
  <span id="speed">時速：0 km/h</span>
  <span id="timer">剩餘時間：60 秒</span>
</div>
<div id="popup">
  <h2>遊戲結束！</h2>
  <p id="finalStats"></p>
  <button onclick="location.reload()">重新開始</button>
</div>
<video id="debugVideo" autoplay playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

<script>
// === 場景與相機 ===
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,3,8);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);
window.addEventListener("resize",()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});

scene.add(new THREE.AmbientLight(0xffffff,0.7));
const light=new THREE.DirectionalLight(0xffffff,0.8);
light.position.set(10,10,5);scene.add(light);

// === 河道 ===
const river=new THREE.Mesh(new THREE.PlaneGeometry(30,1000,50,200),new THREE.MeshPhongMaterial({color:0x2a6fd3,side:THREE.DoubleSide}));
river.rotation.x=-Math.PI/2;
scene.add(river);

// === 船 ===
const boat=new THREE.Group();
const hull=new THREE.Mesh(new THREE.BoxGeometry(1.4,0.4,2.2),new THREE.MeshPhongMaterial({color:0xffcc00}));
boat.add(hull);
const torso=new THREE.Mesh(new THREE.BoxGeometry(0.4,0.8,0.4),new THREE.MeshStandardMaterial({color:0xffffff}));
torso.position.y=0.7;
const head=new THREE.Mesh(new THREE.SphereGeometry(0.25),new THREE.MeshStandardMaterial({color:0xffe0bd}));
head.position.y=1.3;
boat.add(torso);boat.add(head);
boat.position.set(0,0.3,0);
scene.add(boat);

// === 牆與裝飾 ===
function makeWall(x,color){
  const wall=new THREE.Mesh(new THREE.PlaneGeometry(60,200,10,10),new THREE.MeshLambertMaterial({color}));
  wall.rotation.y=x>0?-Math.PI/2:Math.PI/2;
  wall.position.set(x,3,-100);
  scene.add(wall);
  return wall;
}
const leftWall=makeWall(-15,0x4b6939);
const rightWall=makeWall(15,0x3d5530);
function addDecoration(x,z){
  const geo=new THREE.ConeGeometry(0.5+Math.random(),1.5,8);
  const mat=new THREE.MeshLambertMaterial({color:0x225500});
  const tree=new THREE.Mesh(geo,mat);
  tree.position.set(x,0.8,z);
  scene.add(tree);
}
for(let i=0;i<80;i++){
  const side=i%2===0?-13:13;
  addDecoration(side,-i*15-10);
}

// === 坡道 ===
const slopes=[];
function addSlope(z,x,angle){
  const geo=new THREE.PlaneGeometry(6,8,10,10);
  const mat=new THREE.MeshPhongMaterial({color:0x5ec8ff,side:THREE.DoubleSide});
  const slope=new THREE.Mesh(geo,mat);
  slope.rotation.x=-Math.PI/2+THREE.MathUtils.degToRad(angle);
  slope.position.set(x,0,z);
  slope.userData={height:angle/60};
  scene.add(slope);
  slopes.push(slope);
}
for(let i=0;i<6;i++){
  const z=-i*120-40;
  addSlope(z,Math.random()*3-1.5,25+Math.random()*10);
  if(Math.random()<0.4)addSlope(z,Math.random()>0?5:-5,30);
}

// === 障礙 ===
const obstacles=[];
function spawnObstacle(z){
  const geo=new THREE.BoxGeometry(2.5,2,2.5);
  const mat=new THREE.MeshPhongMaterial({color:0x442200});
  const obs=new THREE.Mesh(geo,mat);
  obs.position.set(Math.random()*6-3,1,z);
  scene.add(obs);
  obstacles.push(obs);
}
for(let i=0;i<15;i++)spawnObstacle(-i*40-30);

// === 金幣 ===
const coinGeo=new THREE.TorusGeometry(0.35,0.1,12,24);
const coinMat=new THREE.MeshPhongMaterial({color:0xffd700,emissive:0xaa8800});
const coins=[];
function spawnCoin(z,y){
  const coin=new THREE.Mesh(coinGeo,coinMat.clone());
  coin.position.set(Math.random()*4-2,y,z);
  scene.add(coin);
  coins.push(coin);
}
for(let i=0;i<60;i++){
  const z=-i*15-20;
  const y=(Math.random()<0.3)?1.2:0.4;
  spawnCoin(z,y);
}

// === Mediapipe Pose ===
let speed=0, tilt=0, jumpV=0, isJump=false;
let lastNoseY=0, score=0, maxSpeed=0;
let prevLeftY=0, prevRightY=0;
const scoreEl=document.getElementById("score");
const speedEl=document.getElementById("speed");
const timerEl=document.getElementById("timer");
const popup=document.getElementById("popup");
const finalStats=document.getElementById("finalStats");
const video=document.getElementById("debugVideo");

const pose=new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({modelComplexity:0,smoothLandmarks:true,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
pose.onResults(onPose);

async function startCam(){
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;await video.play();
  const cam=new Camera(video,{onFrame:async()=>{await pose.send({image:video});},width:320,height:180});
  cam.start();
}
startCam();

function onPose(res){
  if(!res.poseLandmarks)return;
  const L=res.poseLandmarks[11],R=res.poseLandmarks[12];
  const N=res.poseLandmarks[0];
  const LW=res.poseLandmarks[15],RW=res.poseLandmarks[16];
  const cx=(L.x+R.x)/2, ny=N.y;
  tilt=(cx-0.5)*30;
  boat.rotation.z=THREE.MathUtils.degToRad(tilt);
  boat.position.x=THREE.MathUtils.clamp(boat.position.x-(cx-0.5)*0.5,-4,4);
  const leftDy=Math.abs(LW.y-prevLeftY);
  const rightDy=Math.abs(RW.y-prevRightY);
  const armMove=(leftDy+rightDy)*0.5;
  if(armMove>0.02){speed=Math.min(speed+0.015,0.18);}
  else{speed=Math.max(speed-0.01,0);}
  prevLeftY=LW.y;prevRightY=RW.y;
  if(lastNoseY-ny>0.07&&!isJump){isJump=true;jumpV=0.15;}
  lastNoseY=ny;
}

// === 遊戲更新 ===
function updateBoat(){
  if(isJump){boat.position.y+=jumpV;jumpV-=0.008;if(boat.position.y<=0.3){boat.position.y=0.3;isJump=false;}}
  boat.position.z-=speed*3;
  camera.position.z=boat.position.z+8;
  camera.lookAt(boat.position.x,boat.position.y,boat.position.z-5);
  leftWall.position.z=boat.position.z-100;rightWall.position.z=boat.position.z-100;
  const kmh=(speed*200).toFixed(1);
  speedEl.textContent=`時速：${kmh} km/h`;
  if(speed>maxSpeed)maxSpeed=speed;
}
function updateCoins(){
  coins.forEach(c=>{
    c.rotation.y+=0.1;
    const dz=c.position.z-boat.position.z;
    if(dz>10)c.position.z=boat.position.z-400;
    const dist=boat.position.distanceTo(c.position);
    if(dist<1){score++;scoreEl.textContent="分數："+score;c.position.z=boat.position.z-400;}
  });
}
function updateSlopes(){
  slopes.forEach(s=>{
    const dz=boat.position.z-s.position.z;
    if(Math.abs(dz)<4&&Math.abs(boat.position.x-s.position.x)<3){
      const h=s.userData.height;
      boat.position.y=0.3+Math.max(0,(4-Math.abs(dz)))*h;
    }
  });
}
function checkObstacles(){
  obstacles.forEach(o=>{
    const dz=o.position.z-boat.position.z;
    if(dz>10){o.position.z=boat.position.z-400;o.position.x=Math.random()*8-4;}
    const dist=boat.position.distanceTo(o.position);
    if(dist<1.5){speed*=0.5;boat.position.x+=Math.sign(boat.position.x-o.position.x)*0.3;}
  });
}

// === 倒數與結算 ===
let timeLeft=60;
const timer=setInterval(()=>{
  timeLeft--;
  timerEl.textContent=`剩餘時間：${timeLeft} 秒`;
  if(timeLeft<=0){
    clearInterval(timer);
    endGame();
  }
},1000);

function endGame(){
  popup.style.display="flex";
  const kmhMax=(maxSpeed*200).toFixed(1);
  finalStats.innerHTML=`最終分數：${score}<br>最高時速：${kmhMax} km/h`;
}

// === 動畫 ===
function animate(){
  requestAnimationFrame(animate);
  if(speed>0) river.position.z-=speed*3;
  updateBoat();
  updateCoins();
  updateSlopes();
  checkObstacles();
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
